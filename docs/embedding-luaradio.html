<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <title>LuaRadio - Embedding LuaRadio</title>
  
  <meta name="author" content="Vanya A. Sergeev" />
  <meta name="description" content="LuaRadio" />
  <link rel="canonical" href="https://luaradio.io/docs/embedding-luaradio.html" />
  <link rel="icon" type="image/x-icon" href="../favicon.ico" />

  <link rel="stylesheet" href="../assets/css/all.css">
  <script type="text/javascript" src="../assets/js/tocbot.min.js"></script>
  <script type="text/javascript" src="../assets/js/toc.js"></script>

  
  
</head>
<body id="top">
  <div class="container">
    <div class="row">
      <div class="three columns sidebar">
        <nav class="menu">
  <h1 class="title"><a href="..">LuaRadio</a></h1>
  <div class="links">
      <a href="https://github.com/vsergeev/luaradio/blob/master/CHANGELOG.md"><i class="fa fa-link fa-fw" aria-hidden="true"></i> <code class="version">v0.11.0</code></a><br />
      <a href="https://github.com/vsergeev/luaradio"><i class="fa fa-github fa-fw" aria-hidden="true"></i> GitHub</a><br />
      <a href="https://groups.io/g/luaradio"><i class="fa fa-envelope fa-fw" aria-hidden="true"></i> Mailing List</a>
  </div>
  <div class="toc">
    <ul>
        <li><a href="../new-to-sdr.html">New to SDR?</a></li>
        <li><a href="../docs/">Documentation</a>
            <ul>
                <li><a href="../docs/installation.html">Installation</a></li>
                <li><a href="../docs/getting-started.html">Getting Started</a></li>
                <li><a href="../docs/creating-blocks.html">Creating Blocks</a></li>
                <li><a href="../docs/embedding-luaradio.html">Embedding LuaRadio</a></li>
                <li><a href="../docs/architecture.html">Architecture</a></li>
                <li><a href="../docs/comparison-gnuradio.html">Comparison to GNU Radio</a></li>
                <li><a href="../docs/supported-hardware.html">Supported Hardware</a></li>
                <li><a href="../docs/applications.html">Built-in Applications</a></li>
            </ul>
        </li>
        <li><a href="../docs/reference-manual.html">Reference Manual</a></li>
        <li><a href="https://github.com/vsergeev/luaradio/wiki#project-roadmap">Project Roadmap</a></li>
        <li><a href="../examples/">Examples</a>
            <ul>
                <li><a href="../examples/rtlsdr-wbfm-mono.html">WBFM Mono</a></li>
                <li><a href="../examples/rtlsdr-wbfm-stereo.html">WBFM Stereo</a></li>
                <li><a href="../examples/rtlsdr-nbfm.html">NBFM</a></li>
                <li><a href="../examples/rtlsdr-ax25.html">AX.25</a></li>
                <li><a href="../examples/rtlsdr-pocsag.html">POCSAG</a></li>
                <li><a href="../examples/rtlsdr-rds.html">RDS</a></li>
                <li><a href="../examples/rtlsdr-am-envelope.html">AM (Envelope)</a></li>
                <li><a href="../examples/rtlsdr-am-synchronous.html">AM (Synchronous)</a></li>
                <li><a href="../examples/rtlsdr-ssb.html">SSB</a></li>
                <li><a href="../examples/wavfile-ssb-modulator.html">WAV SSB Modulator</a></li>
                <li><a href="../examples/iqfile-converter.html">IQ File Converter</a></li>
            </ul>
        </li>
        <li><a href="../benchmarks.html">Benchmarks</a></li>
    </ul>
  </div>
  <a class="contact" href="mailto:v@sergeev.io"><i class="fa fa-envelope-o" aria-hidden="true"></i> v@sergeev.io</a>
</nav>

        <nav class="scroll-toc">
  <h1 class="title"><a data-scroll href="#top">LuaRadio</a></h1>
  <div class="links">
    <a href="https://github.com/vsergeev/luaradio/blob/master/CHANGELOG.md"><i class="fa fa-link fa-fw" aria-hidden="true"></i> <code class="version">v0.11.0</code></a><br />
    <a href="https://github.com/vsergeev/luaradio"><i class="fa fa-github fa-fw" aria-hidden="true"></i> GitHub</a><br />
    <a href="https://groups.io/g/luaradio"><i class="fa fa-envelope fa-fw" aria-hidden="true"></i> Mailing List</a>
  </div>
  <div class="toc">
    <span class="page-title"><a data-scroll href="#top">Embedding LuaRadio</a></span>
    <div class="js-toc">
    </div>
  </div>
</nav>

      </div>
      <div class="nine columns content">
        
<h1 id="embedding-luaradio">Embedding LuaRadio</h1>

<p>This document describes how to embed LuaRadio into host applications, and how
applications can source or sink samples with LuaRadio flow graphs.</p>

<h2 id="table-of-contents">Table of Contents</h2>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#c-api-synopsis">C API Synopsis</a></li>
  <li><a href="#interfacing-samples">Interfacing Samples</a></li>
  <li><a href="#examples">Examples</a>
    <ul>
      <li><a href="#fm-radio">FM Radio</a></li>
      <li><a href="#rds-timesync">RDS Timesync</a></li>
    </ul>
  </li>
  <li><a href="#building">Building</a>
    <ul>
      <li><a href="#dynamically-linked">Dynamically Linked</a></li>
      <li><a href="#statically-linked">Statically Linked</a></li>
    </ul>
  </li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>LuaRadio can be run directly from its Lua file sources, but when it is
installed as a shared library, it is packaged into one dual-purpose shared
library called <code class="language-plaintext highlighter-rouge">libluaradio</code>.</p>

<p>This library can both be loaded as the <code class="language-plaintext highlighter-rouge">radio</code> module by LuaJIT for use in
LuaRadio scripts, as well as linked into C/C++ applications to embed the
LuaRadio engine. The packaged library contains the entire LuaRadio framework,
bytecode compiled, as well as a small C API for creating LuaRadio contexts,
loading scripts with a top-level flow graph, and controlling the top-level flow
graph.</p>

<p>A LuaRadio packaged shared library installation provides the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/usr/bin/luaradio</code> — LuaRadio runner helper script</li>
  <li><code class="language-plaintext highlighter-rouge">/usr/lib/libluaradio.so</code> — Shared library for dynamic linking</li>
  <li><code class="language-plaintext highlighter-rouge">/usr/lib/libluaradio.a</code> — Static library for static linking</li>
  <li><code class="language-plaintext highlighter-rouge">/usr/include/luaradio.h</code> — C API header file</li>
  <li><code class="language-plaintext highlighter-rouge">/usr/lib/lua/5.1/radio.so</code> <em>-symlink-&gt;</em> <code class="language-plaintext highlighter-rouge">/usr/lib/libluaradio.so</code> — Lua module</li>
</ul>

<p>Dynamically linking <code class="language-plaintext highlighter-rouge">libluaradio.so</code> and <code class="language-plaintext highlighter-rouge">libluajit-5.1.so</code> into an application
enables it to run LuaRadio scripts. Statically linking the static equivalent of
these libraries allows building entirely standalone executables with LuaRadio.</p>

<h2 id="c-api-synopsis">C API Synopsis</h2>

<p>The LuaRadio packaged library includes a small <a href="https://github.com/vsergeev/luaradio/tree/master/embed/luaradio.h">C API</a>
that wraps the details of Lua states and the <code class="language-plaintext highlighter-rouge">radio</code> package. This simplified
interface provides for creating a LuaRadio context, loading a script with a
top-level flow graph, and the basic control functions of the top-level flow
graph (start, status, wait, stop).</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Create a new LuaRadio context. */</span>
<span class="n">luaradio_t</span> <span class="o">*</span><span class="nf">luaradio_new</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Load a script that returns a LuaRadio flow graph. */</span>
<span class="kt">int</span> <span class="nf">luaradio_load</span><span class="p">(</span><span class="n">luaradio_t</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">script</span><span class="p">);</span>

<span class="cm">/* Start a LuaRadio flow graph. */</span>
<span class="kt">int</span> <span class="nf">luaradio_start</span><span class="p">(</span><span class="n">luaradio_t</span> <span class="o">*</span><span class="n">radio</span><span class="p">);</span>

<span class="cm">/* Get the running status of a LuaRadio flow graph. */</span>
<span class="kt">int</span> <span class="nf">luaradio_status</span><span class="p">(</span><span class="n">luaradio_t</span> <span class="o">*</span><span class="n">radio</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">running</span><span class="p">);</span>

<span class="cm">/* Wait for a LuaRadio flow graph to finish. */</span>
<span class="kt">int</span> <span class="nf">luaradio_wait</span><span class="p">(</span><span class="n">luaradio_t</span> <span class="o">*</span><span class="n">radio</span><span class="p">);</span>

<span class="cm">/* Stop a LuaRadio flow graph. */</span>
<span class="kt">int</span> <span class="nf">luaradio_stop</span><span class="p">(</span><span class="n">luaradio_t</span> <span class="o">*</span><span class="n">radio</span><span class="p">);</span>

<span class="cm">/* Free a LuaRadio context. */</span>
<span class="kt">void</span> <span class="nf">luaradio_free</span><span class="p">(</span><span class="n">luaradio_t</span> <span class="o">*</span><span class="n">radio</span><span class="p">);</span>

<span class="cm">/* Get the Lua state of a LuaRadio context. */</span>
<span class="n">lua_State</span> <span class="o">*</span><span class="nf">luaradio_get_state</span><span class="p">(</span><span class="n">luaradio_t</span> <span class="o">*</span><span class="n">radio</span><span class="p">);</span>

<span class="cm">/* Get a human readable error message for the last error that occurred. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">luaradio_strerror</span><span class="p">(</span><span class="n">luaradio_t</span> <span class="o">*</span><span class="n">radio</span><span class="p">);</span>

<span class="cm">/* Get LuaRadio version info */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">luaradio_version</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">luaradio_version_number</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">const</span> <span class="n">luaradio_version_t</span> <span class="o">*</span><span class="nf">luaradio_version_info</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></div></div>

<p>The C API also defines the C types corresponding to the four basic data types
<a href="reference-manual.html#complexfloat32"><code class="language-plaintext highlighter-rouge">radio.types.ComplexFloat32</code></a>,
<a href="reference-manual.html#float32"><code class="language-plaintext highlighter-rouge">radio.types.Float32</code></a>,
<a href="reference-manual.html#bit"><code class="language-plaintext highlighter-rouge">radio.types.Bit</code></a>, and
<a href="reference-manual.html#byte"><code class="language-plaintext highlighter-rouge">radio.types.Byte</code></a>, under <code class="language-plaintext highlighter-rouge">complex_float32_t</code>,
<code class="language-plaintext highlighter-rouge">float32_t</code>, <code class="language-plaintext highlighter-rouge">bit_t</code>, <code class="language-plaintext highlighter-rouge">byte_t</code>, respectively.</p>

<p>In basic usage of the API, applications create a LuaRadio context with
<code class="language-plaintext highlighter-rouge">luaradio_new()</code>, load a script that returns a top-level flow graph with
<code class="language-plaintext highlighter-rouge">luaradio_load()</code>, and start the flow graph with <code class="language-plaintext highlighter-rouge">luaradio_start()</code>.</p>

<p>After this, <code class="language-plaintext highlighter-rouge">luaradio_status()</code>, <code class="language-plaintext highlighter-rouge">luaradio_wait()</code>, and <code class="language-plaintext highlighter-rouge">luaradio_stop()</code> can
be used to get the running status of the flow graph, wait on the flow graph to
finish, or stop the flow graph, respectively.  These calls correspond to the
<a href="reference-manual.html#compositeblock"><code class="language-plaintext highlighter-rouge">CompositeBlock</code></a> methods of the same
name.</p>

<p>When the flow graph is terminated and work with the context is complete, the
context can be freed with <code class="language-plaintext highlighter-rouge">luaradio_free()</code>.</p>

<p>In more advanced usage, applications may access the Lua state of the LuaRadio
context with <code class="language-plaintext highlighter-rouge">luaradio_get_state()</code> . Applications can use this with the Lua C
API to prepare a custom environment for scripts prior to loading them.</p>

<p>Most API functions return 0 on success or a negative integer code on failure.
<code class="language-plaintext highlighter-rouge">luaradio_new()</code> returns <code class="language-plaintext highlighter-rouge">NULL</code> on memory allocation failure.
<code class="language-plaintext highlighter-rouge">luaradio_strerror()</code> can be used to get a human-readable error string of the
last failure that occurred.</p>

<p>The API is re-entrant, as all relevant state is maintained in the <code class="language-plaintext highlighter-rouge">luaradio_t</code>
context.</p>

<h2 id="interfacing-samples">Interfacing Samples</h2>

<p>An application may source or sink samples in a LuaRadio flow graph through a
pair of connected file descriptors, e.g. from <code class="language-plaintext highlighter-rouge">pipe()</code> or <code class="language-plaintext highlighter-rouge">socketpair()</code>.  A
file descriptor can be handed off to LuaRadio as a parameter to a
<a href="reference-manual.html#rawfilesource"><code class="language-plaintext highlighter-rouge">RawFileSource</code></a>, if the application is
sourcing samples, or a <a href="reference-manual.html#rawfilesink"><code class="language-plaintext highlighter-rouge">RawFileSink</code></a>, if
the application is sinking samples, or both.</p>

<p>The application can then use standard file descriptor I/O calls <code class="language-plaintext highlighter-rouge">read()</code> or
<code class="language-plaintext highlighter-rouge">write()</code> on its file descriptor to serialize samples from or to LuaRadio. The
application must know the C type of the samples, as the samples are read and
written raw, in their native memory representation, with no marshalling.</p>

<p>In the case of an application sinking samples of a variable-sized
<a href="reference-manual.html#objecttype"><code class="language-plaintext highlighter-rouge">Object</code></a> based data type (e.g. for a
decoded packet type), the <a href="reference-manual.html#jsonsink"><code class="language-plaintext highlighter-rouge">JSONSink</code></a> can be
used.  This sink accepts a file descriptor parameter, like the <code class="language-plaintext highlighter-rouge">RawFileSink</code>,
but serializes individual samples with JSON, separated by a newline delimiter.
The application can split each serialized sample by the newline delimiter, and
deserialize the sample with JSON.</p>

<p>In the examples below, file descriptor hand-off and parameter passing happens
through string substitution of a script template. This solution is simple and
demonstrates how to embed a LuaRadio script, but is inherently prone to
unintended errors and injection.</p>

<p>The recommended approach for applications adding support for user defined
LuaRadio scripts is to use the <a href="https://www.lua.org/manual/5.1/manual.html#3">Lua C
API</a> with the underlying Lua
state of the LuaRadio context (see <code class="language-plaintext highlighter-rouge">luaradio_get_state()</code>) to define a custom
environment. For example, the application might define an environment
containing variables with the source and sink file descriptors, or even
pre-instantiated <code class="language-plaintext highlighter-rouge">RawFileSource</code> and <code class="language-plaintext highlighter-rouge">RawFileSink</code> blocks, that can be used in
the user defined scripts as sources from or sinks to the application.</p>

<h5 id="aside">Aside</h5>

<p>Embedding LuaRadio means embedding an interpreter and framework that is not
native to the application. This is powerful when the goal is to provide the
user with the ability to define arbitrary radio scripts, but it’s not as
satisfying when the goal is to leverage LuaRadio as a signal processing engine
for a pre-defined flow graph, because the flow graph blocks do not feel like
first-class citizens to the application. On the other hand, the alternative —
binding every block into a language — adds other layers of complexity like code
generation and mapping types.</p>

<h2 id="examples">Examples</h2>

<h3 id="fm-radio">FM Radio</h3>

<p>The FM Radio example is a command-line FM broadcast radio receiver, built with
a small flow graph containing an
<a href="reference-manual.html#rtlsdrsource"><code class="language-plaintext highlighter-rouge">RtlSdrSource</code></a>, a
<a href="reference-manual.html#wbfmmonodemodulator"><code class="language-plaintext highlighter-rouge">WBFMMonoDemodulator</code></a>, and a
<a href="reference-manual.html#pulseaudiosink"><code class="language-plaintext highlighter-rouge">PulseAudioSink</code></a>. It accepts the
station frequency from the command-line and substitutes it into the flow graph
script.</p>

<p align="center">
<img src="figures/flowgraph_rtlsdr_wbfm_mono_demodulator_composite.png" />
</p>

<p>This example demonstrates basic use of the C API.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#include &lt;luaradio.h&gt;
</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">script_template</span> <span class="o">=</span>
    <span class="s">"local frequency = %f</span><span class="se">\n</span><span class="s">"</span>
    <span class="s">"return radio.CompositeBlock():connect("</span>
    <span class="s">"    radio.RtlSdrSource(frequency - 250e3, 1102500),"</span>
    <span class="s">"    radio.TunerBlock(-250e3, 200e3, 5),"</span>
    <span class="s">"    radio.WBFMMonoDemodulator(),"</span>
    <span class="s">"    radio.DownsamplerBlock(5),"</span>
    <span class="s">"    radio.PulseAudioSink(1)"</span>
    <span class="s">")"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">luaradio_t</span> <span class="o">*</span><span class="n">radio</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">script</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Usage: %s &lt;FM station frequency&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Substitute station frequency in script template */</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">script</span><span class="p">),</span> <span class="n">script_template</span><span class="p">,</span> <span class="n">atof</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

    <span class="cm">/* Create context */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">radio</span> <span class="o">=</span> <span class="n">luaradio_new</span><span class="p">())</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"Allocating memory"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Load flow graph */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">luaradio_load</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error loading flow graph: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">luaradio_strerror</span><span class="p">(</span><span class="n">radio</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Start flow graph */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">luaradio_start</span><span class="p">(</span><span class="n">radio</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error starting flow graph: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">luaradio_strerror</span><span class="p">(</span><span class="n">radio</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Wait until completion */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">luaradio_wait</span><span class="p">(</span><span class="n">radio</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error waiting for flow graph: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">luaradio_strerror</span><span class="p">(</span><span class="n">radio</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Free context */</span>
    <span class="n">luaradio_free</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This example may be built in the <a href="https://github.com/vsergeev/luaradio/tree/master/embed/">embed</a> directory with <code class="language-plaintext highlighter-rouge">make examples</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>luaradio/embed $ make examples
...
luaradio/embed $ export LD_LIBRARY_PATH=build
luaradio/embed $ ./build/examples/fm-radio
Usage: ./build/examples/fm-radio &lt;FM station frequency&gt;
luaradio/embed $
</code></pre></div></div>

<p>Listen to 91.1 MHz:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>luaradio/embed $ ./build/examples/fm-radio 91.1e6
</code></pre></div></div>

<p>Note: there is no need to set <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> if LuaRadio is installed, as
<code class="language-plaintext highlighter-rouge">libluaradio.so.0</code> will be in a library search path like <code class="language-plaintext highlighter-rouge">/usr/lib</code>.</p>

<h3 id="rds-timesync">RDS Timesync</h3>

<p><a href="https://en.wikipedia.org/wiki/Radio_Data_System">Radio Data Service</a> (RDS) is
a digital protocol used by FM broadcast radio stations to transmit metadata
about the station and its programming. This protocol is most commonly known for
providing station and song text information with “RadioText” messages, but the
standard specifies a variety of other message types (see the <a href="http://www.interactive-radio-system.com/docs/EN50067_RDS_Standard.pdf">RDS Standard
(PDF)</a>).
One message type in particular — type 4A (see pg. 28) — contains time and date
information. RDS-enabled FM radio stations transmit it once every minute.</p>

<p>The RDS timesync example is a command-line tool that sets the system time and
date to an RDS-enabled FM radio station.  It is built with a small flow graph
containing an <a href="reference-manual.html#rtlsdrsource"><code class="language-plaintext highlighter-rouge">RtlSdrSource</code></a>, an
<a href="reference-manual.html#rdsreceiver"><code class="language-plaintext highlighter-rouge">RDSReceiver</code></a>, and a
<a href="reference-manual.html#rawfilesink"><code class="language-plaintext highlighter-rouge">RawFileSink</code></a>.  The frames decoded by the
RDS receiver are serialized to the C application through the <code class="language-plaintext highlighter-rouge">RawFileSink</code>. The
C application scans for the time and date message type, and once it finds one,
decodes it and sets the system time and date to it.</p>

<p align="center">
<img src="figures/flowgraph_rtlsdr_rds_composite.png" />
</p>

<p>This example demonstrates how to serialize samples from a LuaRadio flow graph
to an application.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdint.h&gt;
#include &lt;unistd.h&gt;
#include &lt;time.h&gt;
#include &lt;sys/time.h&gt;
</span>
<span class="cp">#include &lt;luaradio.h&gt;
</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">script_template</span> <span class="o">=</span>
    <span class="s">"local frequency = %f</span><span class="se">\n</span><span class="s">"</span>
    <span class="s">"return radio.CompositeBlock():connect("</span>
    <span class="s">"    radio.RtlSdrSource(frequency - 250e3, 1102500),"</span>
    <span class="s">"    radio.TunerBlock(-250e3, 200e3, 5),"</span>
    <span class="s">"    radio.RDSReceiver(),"</span>
    <span class="s">"    radio.RawFileSink(%d)"</span>
    <span class="s">")"</span><span class="p">;</span>

<span class="cm">/* radio.RDSFramerBlock.RDSFrameType */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">}</span> <span class="n">rds_frame_t</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">time_t</span> <span class="nf">rds_decode_time</span><span class="p">(</span><span class="k">const</span> <span class="n">rds_frame_t</span> <span class="o">*</span><span class="n">time_frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* See RDS Standard 3.1.5.6, pg. 28 */</span>
    <span class="cm">/* Extract modified julian date, hour, minute */</span>
    <span class="kt">uint32_t</span> <span class="n">mjd</span> <span class="o">=</span> <span class="p">((</span><span class="n">time_frame</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">time_frame</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">hour</span> <span class="o">=</span> <span class="p">((</span><span class="n">time_frame</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">time_frame</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">minute</span> <span class="o">=</span> <span class="p">((</span><span class="n">time_frame</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>

    <span class="cm">/* See RDS Standard Annex G, pg. 81 */</span>
    <span class="cm">/* Convert modified julian date to year, month, day */</span>
    <span class="kt">uint32_t</span> <span class="n">yp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(((</span><span class="kt">float</span><span class="p">)</span><span class="n">mjd</span> <span class="o">-</span> <span class="mi">15078</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span><span class="p">.</span><span class="mi">25</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(((</span><span class="kt">float</span><span class="p">)</span><span class="n">mjd</span> <span class="o">-</span> <span class="mi">14956</span><span class="p">.</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)((</span><span class="kt">float</span><span class="p">)</span><span class="n">yp</span> <span class="o">*</span> <span class="mi">365</span><span class="p">.</span><span class="mi">25</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">30</span><span class="p">.</span><span class="mi">6001</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">mp</span> <span class="o">==</span> <span class="mi">14</span> <span class="o">||</span> <span class="n">mp</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">day</span> <span class="o">=</span> <span class="n">mjd</span> <span class="o">-</span> <span class="mi">14956</span> <span class="o">-</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)((</span><span class="kt">float</span><span class="p">)</span><span class="n">yp</span> <span class="o">*</span> <span class="mi">365</span><span class="p">.</span><span class="mi">25</span><span class="p">))</span><span class="o">-</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)((</span><span class="kt">float</span><span class="p">)</span><span class="n">mp</span> <span class="o">*</span> <span class="mi">30</span><span class="p">.</span><span class="mi">6001</span><span class="p">));</span>
    <span class="kt">uint32_t</span> <span class="n">month</span> <span class="o">=</span> <span class="n">mp</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">12</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">year</span> <span class="o">=</span> <span class="n">yp</span> <span class="o">+</span> <span class="n">k</span><span class="p">;</span>

    <span class="cm">/* Convert hour, minute, year, month, day to time_t */</span>
    <span class="k">struct</span> <span class="n">tm</span> <span class="n">tm</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">minute</span><span class="p">,</span> <span class="p">.</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">hour</span><span class="p">,</span>
        <span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="n">day</span><span class="p">,</span> <span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tm_year</span> <span class="o">=</span> <span class="n">year</span><span class="p">,</span>
        <span class="p">.</span><span class="n">tm_isdst</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="n">timegm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">luaradio_t</span> <span class="o">*</span><span class="n">radio</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">script</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">sink_fds</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">rds_frame_t</span> <span class="n">frame</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Usage: %s &lt;FM station frequency&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Create a pair of connected file descriptors with pipe() */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">sink_fds</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"pipe()"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Substitute station frequency and write fd of pipe in script template */</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">script</span><span class="p">),</span> <span class="n">script_template</span><span class="p">,</span> <span class="n">atof</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">sink_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="cm">/* Create context */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">radio</span> <span class="o">=</span> <span class="n">luaradio_new</span><span class="p">())</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"Allocating memory"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Load flow graph */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">luaradio_load</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error loading flow graph: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">luaradio_strerror</span><span class="p">(</span><span class="n">radio</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Start flow graph */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">luaradio_start</span><span class="p">(</span><span class="n">radio</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error starting flow graph: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">luaradio_strerror</span><span class="p">(</span><span class="n">radio</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="n">frame_count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Read RDS frame from read fd of pipe */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">sink_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"read()"</span><span class="p">);</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r</span><span class="s">RDS frames received:  % 5d"</span><span class="p">,</span> <span class="n">frame_count</span><span class="p">);</span>

        <span class="cm">/* Check if it's a time frame (group = 0x4, version = 0x0) */</span>
        <span class="kt">uint32_t</span> <span class="n">group</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
        <span class="kt">uint32_t</span> <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">==</span> <span class="mh">0x4</span> <span class="o">&amp;&amp;</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">RDS time frame found!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Stop flow graph */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">luaradio_stop</span><span class="p">(</span><span class="n">radio</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error stopping flow graph: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">luaradio_strerror</span><span class="p">(</span><span class="n">radio</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Decode the time */</span>
    <span class="kt">time_t</span> <span class="n">t</span> <span class="o">=</span> <span class="n">rds_decode_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Setting system time to %s"</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">));</span>

    <span class="cm">/* Set system time */</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">t</span><span class="p">,</span> <span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">settimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"settimeofday()"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Free context */</span>
    <span class="n">luaradio_free</span><span class="p">(</span><span class="n">radio</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This example may be built in the <a href="https://github.com/vsergeev/luaradio/tree/master/embed/">embed</a> directory with <code class="language-plaintext highlighter-rouge">make examples</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>luaradio/embed $ make examples
...
luaradio/embed $ export LD_LIBRARY_PATH=build
luaradio/embed $ ./build/examples/rds-timesync
Usage: ./build/examples/fm-radio &lt;FM station frequency&gt;
luaradio/embed $
</code></pre></div></div>

<p>Sync time and date with 88.5 MHz:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>luaradio/embed $ ./build/examples/rds-timesync 88.5e6
RDS frames received:    443
RDS time frame found!
Setting system time to Tue May 10 23:11:00 2016
luaradio/embed $
</code></pre></div></div>

<p>Note: there is no need to set <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> if LuaRadio is installed, as
<code class="language-plaintext highlighter-rouge">libluaradio.so.0</code> will be in a library search path like <code class="language-plaintext highlighter-rouge">/usr/lib</code>.</p>

<h2 id="building">Building</h2>

<h3 id="dynamically-linked">Dynamically Linked</h3>

<p>Compile the examples and link them with the <code class="language-plaintext highlighter-rouge">libluaradio</code> and <code class="language-plaintext highlighter-rouge">libluajit-5.1</code>
shared libraries:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ clang fm-radio.c -o fm-radio -lluaradio -lluajit-5.1 -Wl,-E
$ clang rds-timesync.c -o rds-timesync -lluaradio -lluajit-5.1 -Wl,-E
</code></pre></div></div>

<p>You may need to add header and library paths with <code class="language-plaintext highlighter-rouge">-I</code> and <code class="language-plaintext highlighter-rouge">-L</code>, respectively,
if LuaRadio is not installed to standard paths.</p>

<p>We can check with <code class="language-plaintext highlighter-rouge">ldd</code> that these executables only depend on standard
libraries, <code class="language-plaintext highlighter-rouge">libluaradio</code>, and <code class="language-plaintext highlighter-rouge">libluajit-5.1</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ldd fm-radio
        linux-vdso.so.1 (0x00007ffc76d3a000)
        libluaradio.so.0 =&gt; /usr/lib/libluaradio.so.0 (0x00007f566ac4f000)
        libluajit-5.1.so.2 =&gt; /usr/lib/libluajit-5.1.so.2 (0x00007f566a9df000)
        libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f566a63e000)
        libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007f566a33a000)
        libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007f566a136000)
        libgcc_s.so.1 =&gt; /usr/lib/libgcc_s.so.1 (0x00007f5669f20000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f566ae83000)
$ ldd rds-timesync
        linux-vdso.so.1 (0x00007fff82f42000)
        libluaradio.so.0 =&gt; /usr/lib/libluaradio.so.0 (0x00007f648bc19000)
        libluajit-5.1.so.2 =&gt; /usr/lib/libluajit-5.1.so.2 (0x00007f648b9a9000)
        libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f648b608000)
        libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007f648b304000)
        libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007f648b100000)
        libgcc_s.so.1 =&gt; /usr/lib/libgcc_s.so.1 (0x00007f648aeea000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f648be4d000)
$
</code></pre></div></div>

<h3 id="statically-linked">Statically Linked</h3>

<p>Compile the examples and link them with the <code class="language-plaintext highlighter-rouge">libluaradio</code> and <code class="language-plaintext highlighter-rouge">libluajit</code>
static libraries:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ clang fm-radio.c -o fm-radio -Wl,--whole-archive,-E libluaradio.a -Wl,--no-whole-archive libluajit.a -ldl -lm
$ clang rds-timesync.c -o rds-timesync -Wl,--whole-archive,-E libluaradio.a -Wl,--no-whole-archive libluajit.a -ldl -lm
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">libluajit.a</code> static library can be obtained from <code class="language-plaintext highlighter-rouge">LuaJIT/src/libluajit.a</code>
after building LuaJIT locally.</p>

<p>After stripping symbols, these standalone executables contain the entire
LuaJIT + LuaRadio runtime in 640 KB:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ du -h fm-radio rds-timesync
716K    fm-radio
716K    rds-timesync
$ strip fm-radio rds-timesync
$ du -h fm-radio rds-timesync
640K    fm-radio
640K    rds-timesync
$
</code></pre></div></div>

<p>We can check with <code class="language-plaintext highlighter-rouge">ldd</code> that these executables only depend on standard libraries:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ldd fm-radio
        linux-vdso.so.1 (0x00007fff08556000)
        libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007f9095e02000)
        libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007f9095afe000)
        libgcc_s.so.1 =&gt; /usr/lib/libgcc_s.so.1 (0x00007f90958e8000)
        libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f9095547000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f9096006000)
$ ldd rds-timesync
        linux-vdso.so.1 (0x00007ffe7fdfe000)
        libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007fc708814000)
        libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007fc708510000)
        libgcc_s.so.1 =&gt; /usr/lib/libgcc_s.so.1 (0x00007fc7082fa000)
        libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007fc707f59000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc708a18000)
$
</code></pre></div></div>



        <div class="footer">
          <div class="disclaimer">
  <p>
    © Vanya A. Sergeev, 2016-2021 &mdash; built with <a href="http://jekyllrb.com/">Jekyll</a>, theme based on <a href="https://github.com/swanson/lagom">Lagom</a>
  </p>
</div>

        </div>
      </div>
    </div>
  </div>
</body>
</html>
